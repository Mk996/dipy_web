{"parents": [], "prev": null, "next": null, "title": "Using the free water elimination model to remove DTI free water contamination", "meta": {}, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-reconstruction-reconst-fwdti-py\"><span class=\"std std-ref\">here</span></a>     to download the full example code</p>\n</div>\n<div class=\"sphx-glr-example-title section\" id=\"using-the-free-water-elimination-model-to-remove-dti-free-water-contamination\">\n<span id=\"sphx-glr-examples-built-reconstruction-reconst-fwdti-py\"></span><h1>Using the free water elimination model to remove DTI free water contamination<a class=\"headerlink\" href=\"#using-the-free-water-elimination-model-to-remove-dti-free-water-contamination\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>As shown previously (see <a class=\"reference internal\" href=\"../../reconst_dti/#example-reconst-dti\"><span class=\"std std-ref\">Reconstruction of the diffusion signal with the Tensor model</span></a>), the diffusion tensor\nmodel is a simple way to characterize diffusion anisotropy. However, in regions\nnear the cerebral ventricle and parenchyma can be underestimated by partial\nvolume effects of the cerebral spinal fluid (CSF). This free water\ncontamination can particularly corrupt Diffusion Tensor Imaging analysis of\nmicrostructural changes when different groups of subjects show different brain\nmorphology (e.g. brain ventricle enlargement associated with brain tissue\natrophy that occurs in several brain pathologies and ageing).</p>\n<p>A way to remove this free water influences is to expand the DTI model to take\ninto account an extra compartment representing the contributions of free water\ndiffusion <a class=\"reference internal\" href=\"#pasternak2009\" id=\"id1\"><span>[Pasternak2009]</span></a>. The expression of the expanded DTI model is shown\nbelow:</p>\n<div class=\"math notranslate nohighlight\">\n\\[S(\\mathbf{g}, b) = S_0(1-f)e^{-b\\mathbf{g}^T \\mathbf{D}\n\\mathbf{g}}+S_0fe^{-b D_{iso}}\\]</div>\n<p>where <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}\\)</span> and <span class=\"math notranslate nohighlight\">\\(b\\)</span> are diffusion gradient direction and weighted\n(more information see <a class=\"reference internal\" href=\"../../reconst_dti/#example-reconst-dti\"><span class=\"std std-ref\">Reconstruction of the diffusion signal with the Tensor model</span></a>), <span class=\"math notranslate nohighlight\">\\(S(\\mathbf{g}, b)\\)</span> is the\ndiffusion-weighted signal measured, <span class=\"math notranslate nohighlight\">\\(S_0\\)</span> is the signal in a measurement with\nno diffusion weighting, <span class=\"math notranslate nohighlight\">\\(\\mathbf{D}\\)</span> is the diffusion tensor, <span class=\"math notranslate nohighlight\">\\(f\\)</span> the volume\nfraction of the free water component, and <span class=\"math notranslate nohighlight\">\\(D_{iso}\\)</span> is the isotropic value of\nthe free water diffusion (normally set to <span class=\"math notranslate nohighlight\">\\(3.0  imes 10^{-3} mm^{2}s^{-1}\\)</span>).</p>\n<p>In this example, we show how to process a diffusion weighting dataset using\nan adapted version of the free water elimination proposed by <a class=\"reference internal\" href=\"#hoy2014\" id=\"id2\"><span>[Hoy2014]</span></a>.</p>\n<p>The full details of Dipy\u2019s free water DTI implementation was published in\n<a class=\"reference internal\" href=\"#henriques2017\" id=\"id3\"><span>[Henriques2017]</span></a>. Please cite this work if you use this algorithm.</p>\n<p>Let\u2019s start by importing the relevant modules:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">import</span> <span class=\"nn\">dipy.reconst.fwdti</span> <span class=\"k\">as</span> <span class=\"nn\">fwdti</span>\n<span class=\"kn\">import</span> <span class=\"nn\">dipy.reconst.dti</span> <span class=\"k\">as</span> <span class=\"nn\">dti</span>\n<span class=\"kn\">import</span> <span class=\"nn\">matplotlib.pyplot</span> <span class=\"k\">as</span> <span class=\"nn\">plt</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"k\">import</span> <span class=\"n\">fetch_cenir_multib</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"k\">import</span> <span class=\"n\">read_cenir_multib</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.segment.mask</span> <span class=\"k\">import</span> <span class=\"n\">median_otsu</span>\n</pre></div>\n</div>\n<p>Without spatial constrains the free water elimination model cannot be solved\nin data acquired from one non-zero b-value <a class=\"reference internal\" href=\"#hoy2014\" id=\"id4\"><span>[Hoy2014]</span></a>. Therefore, here we\ndownload a dataset that was required from multiple b-values.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fetch_cenir_multib</span><span class=\"p\">(</span><span class=\"n\">with_raw</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p class=\"sphx-glr-script-out\">Out:</p>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>({&#39;4D_dwi_eddycor_B200.nii.gz&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/4D_dwi_eddycor_B200.nii.gz&#39;, &#39;fd704aa3deb83c1c7229202cb3db8c48&#39;), &#39;dwi_bvals_B200&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/dwi_bvals_B200&#39;, &#39;80ae5df76a575fe5bf9f1164bb0d4cfb&#39;), &#39;dwi_bvecs_B200&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/dwi_bvecs_B200&#39;, &#39;18e90f8a3e6a4db2457e5b1ba1cc98a9&#39;), &#39;4D_dwieddycor_B400.nii.gz&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/4D_dwieddycor_B400.nii.gz&#39;, &#39;3d0f2b8ef7b6a4a3aa5c4f7a90c9cfec&#39;), &#39;bvals_B400&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvals_B400&#39;, &#39;c38056c40c9cc42372232d6e75c47f54&#39;), &#39;bvecs_B400&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvecs_B400&#39;, &#39;810d79b4c30cb7dff3b2000017d5f72a&#39;), &#39;4D_dwieddycor_B1000.nii.gz&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/4D_dwieddycor_B1000.nii.gz&#39;, &#39;dde8037601a14436b2173f4345b5fd17&#39;), &#39;bvals_B1000&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvals_B1000&#39;, &#39;97de6a492ae304f39e0b418b6ebac64c&#39;), &#39;bvecs_B1000&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvecs_B1000&#39;, &#39;f28a0faa701bdfc66e31bde471a5b992&#39;), &#39;4D_dwieddycor_B2000.nii.gz&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/4D_dwieddycor_B2000.nii.gz&#39;, &#39;c5e4b96e3afdee99c0e994eff3b2331a&#39;), &#39;bvals_B2000&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvals_B2000&#39;, &#39;9c83b8d5caf9c3def240f320f2d2f56c&#39;), &#39;bvecs_B2000&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvecs_B2000&#39;, &#39;05446bd261d57193d8dbc097e06db5ff&#39;), &#39;4D_dwieddycor_B3000.nii.gz&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/4D_dwieddycor_B3000.nii.gz&#39;, &#39;f0d70456ce424fda2cecd48e64f3a151&#39;), &#39;bvals_B3000&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvals_B3000&#39;, &#39;336accdb56acbbeff8dac1748d15ceb8&#39;), &#39;bvecs_B3000&#39;: (&#39;https://digital.lib.washington.edu/researchworks/bitstream/handle/1773/33311/bvecs_B3000&#39;, &#39;27089f3baaf881d96f6a9da202e3d69b&#39;)}, &#39;/Users/koudoro/.dipy/cenir_multib&#39;)\n</pre></div>\n</div>\n<p>From the downloaded data, we read only the data acquired with b-values up to\n2000 <span class=\"math notranslate nohighlight\">\\(s/mm^2\\)</span> to decrease the influence of non-Gaussian diffusion\neffects of the tissue which are not taken into account by the free water\nelimination model <a class=\"reference internal\" href=\"#hoy2014\" id=\"id5\"><span>[Hoy2014]</span></a>.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">bvals</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"mi\">200</span><span class=\"p\">,</span> <span class=\"mi\">400</span><span class=\"p\">,</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"mi\">2000</span><span class=\"p\">]</span>\n\n<span class=\"n\">img</span><span class=\"p\">,</span> <span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">read_cenir_multib</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">asarray</span><span class=\"p\">(</span><span class=\"n\">img</span><span class=\"o\">.</span><span class=\"n\">dataobj</span><span class=\"p\">)</span>\n\n<span class=\"n\">affine</span> <span class=\"o\">=</span> <span class=\"n\">img</span><span class=\"o\">.</span><span class=\"n\">affine</span>\n</pre></div>\n</div>\n<p>The free water DTI model can take some minutes to process the full data set.\nThus, we remove the background of the image to avoid unnecessary\ncalculations.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">maskdata</span><span class=\"p\">,</span> <span class=\"n\">mask</span> <span class=\"o\">=</span> <span class=\"n\">median_otsu</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">vol_idx</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">median_radius</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"n\">numpass</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n                             <span class=\"n\">autocrop</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">dilate</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Moreover, for illustration purposes we process only an axial slice of the\ndata.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">axial_slice</span> <span class=\"o\">=</span> <span class=\"mi\">40</span>\n\n<span class=\"n\">mask_roi</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">zeros</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">bool</span><span class=\"p\">)</span>\n<span class=\"n\">mask_roi</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">mask</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span>\n</pre></div>\n</div>\n<p>The free water elimination model fit can then be initialized by instantiating\na FreeWaterTensorModel class object:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fwdtimodel</span> <span class=\"o\">=</span> <span class=\"n\">fwdti</span><span class=\"o\">.</span><span class=\"n\">FreeWaterTensorModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The data can then be fitted using the <code class=\"docutils literal notranslate\"><span class=\"pre\">fit</span></code> function of the defined model\nobject:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fwdtifit</span> <span class=\"o\">=</span> <span class=\"n\">fwdtimodel</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">mask_roi</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>This 2-steps procedure will create a FreeWaterTensorFit object which contains\nall the diffusion tensor statistics free for free water contaminations. Below\nwe extract the fractional anisotropy (FA) and the mean diffusivity (MD) of\nthe free water diffusion tensor.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">FA</span> <span class=\"o\">=</span> <span class=\"n\">fwdtifit</span><span class=\"o\">.</span><span class=\"n\">fa</span>\n<span class=\"n\">MD</span> <span class=\"o\">=</span> <span class=\"n\">fwdtifit</span><span class=\"o\">.</span><span class=\"n\">md</span>\n</pre></div>\n</div>\n<p>For comparison we also compute the same standard measures processed by the\nstandard DTI model</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">dtimodel</span> <span class=\"o\">=</span> <span class=\"n\">dti</span><span class=\"o\">.</span><span class=\"n\">TensorModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)</span>\n\n<span class=\"n\">dtifit</span> <span class=\"o\">=</span> <span class=\"n\">dtimodel</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">mask_roi</span><span class=\"p\">)</span>\n\n<span class=\"n\">dti_FA</span> <span class=\"o\">=</span> <span class=\"n\">dtifit</span><span class=\"o\">.</span><span class=\"n\">fa</span>\n<span class=\"n\">dti_MD</span> <span class=\"o\">=</span> <span class=\"n\">dtifit</span><span class=\"o\">.</span><span class=\"n\">md</span>\n</pre></div>\n</div>\n<p>Below the FA values for both free water elimination DTI model and standard\nDTI model are plotted in panels A and B, while the repective MD values are\nploted in panels D and E. For a better visualization of the effect of the\nfree water correction, the differences between these two metrics are shown in\npanels C and E. In addition to the standard diffusion statistics, the\nestimated volume fraction of the free water contamination is shown on\npanel G.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig1</span><span class=\"p\">,</span> <span class=\"n\">ax</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">subplots</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">),</span>\n                        <span class=\"n\">subplot_kw</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;xticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[],</span> <span class=\"s1\">&#39;yticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[]})</span>\n\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">subplots_adjust</span><span class=\"p\">(</span><span class=\"n\">hspace</span><span class=\"o\">=</span><span class=\"mf\">0.3</span><span class=\"p\">,</span> <span class=\"n\">wspace</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;A) fwDTI FA&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;B) standard DTI FA&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">FAdiff</span> <span class=\"o\">=</span> <span class=\"nb\">abs</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">])</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FAdiff</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;C) FA difference&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">axis</span><span class=\"p\">(</span><span class=\"s1\">&#39;off&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mf\">2.5e-3</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;D) fwDTI MD&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">dti_MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mf\">2.5e-3</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;E) standard DTI MD&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">MDdiff</span> <span class=\"o\">=</span> <span class=\"nb\">abs</span><span class=\"p\">(</span><span class=\"n\">MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">dti_MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">])</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">MDdiff</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mf\">2.5e-3</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;F) MD difference&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">F</span> <span class=\"o\">=</span> <span class=\"n\">fwdtifit</span><span class=\"o\">.</span><span class=\"n\">f</span>\n\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">F</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;G) free water volume&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">()</span>\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;In_vivo_free_water_DTI_and_standard_DTI_measures.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img alt=\"reconst fwdti\" class=\"sphx-glr-single-img\" src=\"../../../_images/sphx_glr_reconst_fwdti_001.png\" />\n<div class=\"figure align-center\" id=\"id6\">\n<img alt=\"examples_built/reconstruction/In_vivo_free_water_DTI_and_standard_DTI_measures.png\" src=\"examples_built/reconstruction/In_vivo_free_water_DTI_and_standard_DTI_measures.png\" />\n<p class=\"caption\"><span class=\"caption-text\">In vivo diffusion measures obtain from the free water DTI and standard\nDTI. The values of Fractional Anisotropy for the free water DTI model and\nstandard DTI model and their difference are shown in the upper panels\n(A-C), while respective MD values are shown in the lower panels (D-F). In\naddition the free water volume fraction estimated from the fwDTI model is\nshown in panel G.</span><a class=\"headerlink\" href=\"#id6\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<p>From the figure, one can observe that the free water elimination model\nproduces in general higher values of FA and lower values of MD than the\nstandard DTI model. These differences in FA and MD estimation are expected\ndue to the suppression of the free water isotropic diffusion components.\nUnexpected high amplitudes of FA are however observed in the periventricular\ngray matter. This is a known artefact of regions associated to voxels with\nhigh water volume fraction (i.e. voxels containing basically CSF). We are\nable to remove this problematic voxels by excluding all FA values associated\nwith measured volume fractions above a reasonable threshold of 0.7:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">FA</span><span class=\"p\">[</span><span class=\"n\">F</span> <span class=\"o\">&gt;</span> <span class=\"mf\">0.7</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">dti_FA</span><span class=\"p\">[</span><span class=\"n\">F</span> <span class=\"o\">&gt;</span> <span class=\"mf\">0.7</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n</pre></div>\n</div>\n<p>Above we reproduce the plots of the in vivo FA from the two DTI fits and\nwhere we can see that the inflated FA values were practically removed:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig1</span><span class=\"p\">,</span> <span class=\"n\">ax</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">subplots</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">),</span>\n                        <span class=\"n\">subplot_kw</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;xticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[],</span> <span class=\"s1\">&#39;yticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[]})</span>\n\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">subplots_adjust</span><span class=\"p\">(</span><span class=\"n\">hspace</span><span class=\"o\">=</span><span class=\"mf\">0.3</span><span class=\"p\">,</span> <span class=\"n\">wspace</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;A) fwDTI FA&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;B) standard DTI FA&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">FAdiff</span> <span class=\"o\">=</span> <span class=\"nb\">abs</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">axial_slice</span><span class=\"p\">])</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FAdiff</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;C) FA difference&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">()</span>\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;In_vivo_free_water_DTI_and_standard_DTI_corrected.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img alt=\"reconst fwdti\" class=\"sphx-glr-single-img\" src=\"../../../_images/sphx_glr_reconst_fwdti_002.png\" />\n<div class=\"figure align-center\" id=\"id7\">\n<img alt=\"examples_built/reconstruction/In_vivo_free_water_DTI_and_standard_DTI_corrected.png\" src=\"examples_built/reconstruction/In_vivo_free_water_DTI_and_standard_DTI_corrected.png\" />\n<p class=\"caption\"><span class=\"caption-text\">In vivo FA measures obtain from the free water DTI (A) and standard\nDTI (B) and their difference (C). Problematic inflated FA values of the\nimages were removed by dismissing voxels above a volume fraction threshold\nof 0.7.</span><a class=\"headerlink\" href=\"#id7\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<div class=\"section\" id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<dl class=\"citation\">\n<dt class=\"label\" id=\"pasternak2009\"><span class=\"brackets\"><a class=\"fn-backref\" href=\"#id1\">Pasternak2009</a></span></dt>\n<dd><p>Pasternak, O., Sochen, N., Gur, Y., Intrator, N.,\nAssaf, Y., 2009. Free water elimination and mapping from diffusion MRI.\nMagn. Reson. Med. 62(3): 717-30. doi: 10.1002/mrm.22055.</p>\n</dd>\n<dt class=\"label\" id=\"hoy2014\"><span class=\"brackets\">Hoy2014</span><span class=\"fn-backref\">(<a href=\"#id2\">1</a>,<a href=\"#id4\">2</a>,<a href=\"#id5\">3</a>)</span></dt>\n<dd><p>Hoy, A.R., Koay, C.G., Kecskemeti, S.R., Alexander, A.L., 2014.\nOptimization of a free water elimination two-compartmental model for\ndiffusion tensor imaging. NeuroImage 103, 323-333. doi:\n10.1016/j.neuroimage.2014.09.053</p>\n</dd>\n<dt class=\"label\" id=\"henriques2017\"><span class=\"brackets\"><a class=\"fn-backref\" href=\"#id3\">Henriques2017</a></span></dt>\n<dd><p>Henriques, R.N., Rokem, A., Garyfallidis, E., St-Jean, S.,\nPeterson E.T., Correia, M.M., 2017. [Re] Optimization of a free water\nelimination two-compartment model for diffusion tensor imaging.\nReScience volume 3, issue 1, article number 2</p>\n</dd>\n</dl>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 0 minutes  51.455 seconds)</p>\n<div class=\"sphx-glr-footer class sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-reconstruction-reconst-fwdti-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/91e6be38450eecfb2505e7021f1e23ad/reconst_fwdti.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">reconst_fwdti.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/ba607ab7d6dbde5644b51e8e543b1a77/reconst_fwdti.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">reconst_fwdti.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "examples_built/reconstruction/reconst_fwdti.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Using the free water elimination model to remove DTI free water contamination</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/reconstruction/reconst_fwdti", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}