{"parents": [], "prev": null, "next": null, "title": "Symmetric Diffeomorphic Registration in 3D", "meta": {}, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-registration-syn-registration-3d-py\"><span class=\"std std-ref\">here</span></a>     to download the full example code</p>\n</div>\n<div class=\"sphx-glr-example-title section\" id=\"symmetric-diffeomorphic-registration-in-3d\">\n<span id=\"sphx-glr-examples-built-registration-syn-registration-3d-py\"></span><h1>Symmetric Diffeomorphic Registration in 3D<a class=\"headerlink\" href=\"#symmetric-diffeomorphic-registration-in-3d\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>This example explains how to register 3D volumes using the Symmetric\nNormalization (SyN) algorithm proposed by Avants et al. <a class=\"reference internal\" href=\"../../syn_registration_3d/#avants09\" id=\"id1\"><span>[Avants09]</span></a>\n(also implemented in the ANTs software <a class=\"reference internal\" href=\"../../syn_registration_3d/#avants11\" id=\"id2\"><span>[Avants11]</span></a>)</p>\n<p>We will register two 3D volumes from the same modality using SyN with the Cross\n-Correlation (CC) metric.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.align.imwarp</span> <span class=\"k\">import</span> <span class=\"n\">SymmetricDiffeomorphicRegistration</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.align.metrics</span> <span class=\"k\">import</span> <span class=\"n\">CCMetric</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"k\">import</span> <span class=\"n\">get_fnames</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.image</span> <span class=\"k\">import</span> <span class=\"n\">load_nifti</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"k\">import</span> <span class=\"n\">regtools</span>\n</pre></div>\n</div>\n<p>Let\u2019s fetch two b0 volumes, the first one will be the b0 from the Stanford\nHARDI dataset</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_hardi&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">stanford_b0</span><span class=\"p\">,</span> <span class=\"n\">stanford_b0_affine</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">hardi_fname</span><span class=\"p\">)</span>\n<span class=\"n\">stanford_b0</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">squeeze</span><span class=\"p\">(</span><span class=\"n\">stanford_b0</span><span class=\"p\">)[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">]</span>\n</pre></div>\n</div>\n<p>The second one will be the same b0 we used for the 2D registration tutorial</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">t1_fname</span><span class=\"p\">,</span> <span class=\"n\">b0_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;syn_data&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">syn_b0</span><span class=\"p\">,</span> <span class=\"n\">syn_b0_affine</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">b0_fname</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>We first remove the skull from the b0\u2019s</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.segment.mask</span> <span class=\"k\">import</span> <span class=\"n\">median_otsu</span>\n<span class=\"n\">stanford_b0_masked</span><span class=\"p\">,</span> <span class=\"n\">stanford_b0_mask</span> <span class=\"o\">=</span> <span class=\"n\">median_otsu</span><span class=\"p\">(</span><span class=\"n\">stanford_b0</span><span class=\"p\">,</span>\n                                                   <span class=\"n\">median_radius</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">,</span>\n                                                   <span class=\"n\">numpass</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">)</span>\n<span class=\"n\">syn_b0_masked</span><span class=\"p\">,</span> <span class=\"n\">syn_b0_mask</span> <span class=\"o\">=</span> <span class=\"n\">median_otsu</span><span class=\"p\">(</span><span class=\"n\">syn_b0</span><span class=\"p\">,</span> <span class=\"n\">median_radius</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"n\">numpass</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">)</span>\n\n<span class=\"n\">static</span> <span class=\"o\">=</span> <span class=\"n\">stanford_b0_masked</span>\n<span class=\"n\">static_affine</span> <span class=\"o\">=</span> <span class=\"n\">stanford_b0_affine</span>\n<span class=\"n\">moving</span> <span class=\"o\">=</span> <span class=\"n\">syn_b0_masked</span>\n<span class=\"n\">moving_affine</span> <span class=\"o\">=</span> <span class=\"n\">syn_b0_affine</span>\n</pre></div>\n</div>\n<p>Suppose we have already done a linear registration to roughly align the two\nimages</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">pre_align</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">([[</span><span class=\"mf\">1.02783543e+00</span><span class=\"p\">,</span> <span class=\"o\">-</span><span class=\"mf\">4.83019053e-02</span><span class=\"p\">,</span> <span class=\"o\">-</span><span class=\"mf\">6.07735639e-02</span><span class=\"p\">,</span> <span class=\"o\">-</span><span class=\"mf\">2.57654118e+00</span><span class=\"p\">],</span>\n                      <span class=\"p\">[</span><span class=\"mf\">4.34051706e-03</span><span class=\"p\">,</span> <span class=\"mf\">9.41918267e-01</span><span class=\"p\">,</span> <span class=\"o\">-</span><span class=\"mf\">2.66525861e-01</span><span class=\"p\">,</span> <span class=\"mf\">3.23579799e+01</span><span class=\"p\">],</span>\n                      <span class=\"p\">[</span><span class=\"mf\">5.34288908e-02</span><span class=\"p\">,</span> <span class=\"mf\">2.90262026e-01</span><span class=\"p\">,</span> <span class=\"mf\">9.80820307e-01</span><span class=\"p\">,</span> <span class=\"o\">-</span><span class=\"mf\">1.46216651e+01</span><span class=\"p\">],</span>\n                      <span class=\"p\">[</span><span class=\"mf\">0.00000000e+00</span><span class=\"p\">,</span> <span class=\"mf\">0.00000000e+00</span><span class=\"p\">,</span> <span class=\"mf\">0.00000000e+00</span><span class=\"p\">,</span> <span class=\"mf\">1.00000000e+00</span><span class=\"p\">]])</span>\n</pre></div>\n</div>\n<p>As we did in the 2D example, we would like to visualize (some slices of) the\ntwo volumes by overlapping them over two channels of a color image. To do\nthat we need them to be sampled on the same grid, so let\u2019s first re-sample\nthe moving image on the static grid. We create an AffineMap to transform the\nmoving image towards the static image</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.align.imaffine</span> <span class=\"k\">import</span> <span class=\"n\">AffineMap</span>\n<span class=\"n\">affine_map</span> <span class=\"o\">=</span> <span class=\"n\">AffineMap</span><span class=\"p\">(</span><span class=\"n\">pre_align</span><span class=\"p\">,</span>\n                       <span class=\"n\">static</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">,</span> <span class=\"n\">static_affine</span><span class=\"p\">,</span>\n                       <span class=\"n\">moving</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">,</span> <span class=\"n\">moving_affine</span><span class=\"p\">)</span>\n\n<span class=\"n\">resampled</span> <span class=\"o\">=</span> <span class=\"n\">affine_map</span><span class=\"o\">.</span><span class=\"n\">transform</span><span class=\"p\">(</span><span class=\"n\">moving</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>plot the overlapped middle slices of the volumes</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">regtools</span><span class=\"o\">.</span><span class=\"n\">overlay_slices</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">resampled</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Static&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Moving&#39;</span><span class=\"p\">,</span>\n                        <span class=\"s1\">&#39;input_3d.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img alt=\"syn registration 3d\" class=\"sphx-glr-single-img\" src=\"../../../_images/sphx_glr_syn_registration_3d_001.png\" />\n<p class=\"sphx-glr-script-out\">Out:</p>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>&lt;Figure size 640x480 with 3 Axes&gt;\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id3\">\n<img alt=\"examples_built/registration/input_3d.png\" src=\"examples_built/registration/input_3d.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Static image in red on top of the pre-aligned moving image (in green).</span><a class=\"headerlink\" href=\"#id3\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<p>We want to find an invertible map that transforms the moving image into the\nstatic image. We will use the Cross-Correlation metric</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">metric</span> <span class=\"o\">=</span> <span class=\"n\">CCMetric</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Now we define an instance of the registration class. The SyN algorithm uses\na multi-resolution approach by building a Gaussian Pyramid. We instruct the\nregistration object to perform at most <span class=\"math notranslate nohighlight\">\\([n_0, n_1, ..., n_k]\\)</span> iterations at\neach level of the pyramid. The 0-th level corresponds to the finest\nresolution.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">level_iters</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">]</span>\n<span class=\"n\">sdr</span> <span class=\"o\">=</span> <span class=\"n\">SymmetricDiffeomorphicRegistration</span><span class=\"p\">(</span><span class=\"n\">metric</span><span class=\"p\">,</span> <span class=\"n\">level_iters</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Execute the optimization, which returns a DiffeomorphicMap object,\nthat can be used to register images back and forth between the static and\nmoving domains. We provide the pre-aligning matrix that brings the moving\nimage closer to the static image</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">mapping</span> <span class=\"o\">=</span> <span class=\"n\">sdr</span><span class=\"o\">.</span><span class=\"n\">optimize</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">moving</span><span class=\"p\">,</span> <span class=\"n\">static_affine</span><span class=\"p\">,</span> <span class=\"n\">moving_affine</span><span class=\"p\">,</span> <span class=\"n\">pre_align</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Now let\u2019s warp the moving image and see if it gets similar to the static\nimage</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">warped_moving</span> <span class=\"o\">=</span> <span class=\"n\">mapping</span><span class=\"o\">.</span><span class=\"n\">transform</span><span class=\"p\">(</span><span class=\"n\">moving</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>We plot the overlapped middle slices</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">regtools</span><span class=\"o\">.</span><span class=\"n\">overlay_slices</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">warped_moving</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Static&#39;</span><span class=\"p\">,</span>\n                        <span class=\"s1\">&#39;Warped moving&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;warped_moving.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img alt=\"syn registration 3d\" class=\"sphx-glr-single-img\" src=\"../../../_images/sphx_glr_syn_registration_3d_002.png\" />\n<p class=\"sphx-glr-script-out\">Out:</p>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>&lt;Figure size 640x480 with 3 Axes&gt;\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id4\">\n<img alt=\"examples_built/registration/warped_moving.png\" src=\"examples_built/registration/warped_moving.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Moving image transformed under the (direct) transformation in green on top\nof the static image (in red).</span><a class=\"headerlink\" href=\"#id4\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<p>And we can also apply the inverse mapping to verify that the warped static\nimage is similar to the moving image</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">warped_static</span> <span class=\"o\">=</span> <span class=\"n\">mapping</span><span class=\"o\">.</span><span class=\"n\">transform_inverse</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">)</span>\n<span class=\"n\">regtools</span><span class=\"o\">.</span><span class=\"n\">overlay_slices</span><span class=\"p\">(</span><span class=\"n\">warped_static</span><span class=\"p\">,</span> <span class=\"n\">moving</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Warped static&#39;</span><span class=\"p\">,</span>\n                        <span class=\"s1\">&#39;Moving&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;warped_static.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img alt=\"syn registration 3d\" class=\"sphx-glr-single-img\" src=\"../../../_images/sphx_glr_syn_registration_3d_003.png\" />\n<p class=\"sphx-glr-script-out\">Out:</p>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>&lt;Figure size 640x480 with 3 Axes&gt;\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id5\">\n<img alt=\"examples_built/registration/warped_static.png\" src=\"examples_built/registration/warped_static.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Static image transformed under the (inverse) transformation in red on top\nof the moving image (in green). Note that the moving image has a lower\nresolution.</span><a class=\"headerlink\" href=\"#id5\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<div class=\"section\" id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<dl class=\"citation\">\n<dt class=\"label\" id=\"avants09\"><span class=\"brackets\"><a class=\"fn-backref\" href=\"#id1\">Avants09</a></span></dt>\n<dd><p>Avants, B. B., Epstein, C. L., Grossman, M., &amp; Gee, J. C.\n(2009). Symmetric Diffeomorphic Image Registration with Cross-Correlation:\nEvaluating Automated Labeling of Elderly and Neurodegenerative Brain,\n12(1), 26-41.</p>\n</dd>\n<dt class=\"label\" id=\"avants11\"><span class=\"brackets\"><a class=\"fn-backref\" href=\"#id2\">Avants11</a></span></dt>\n<dd><p>Avants, B. B., Tustison, N., &amp; Song, G. (2011). Advanced\nNormalization Tools (ANTS), 1-35.</p>\n</dd>\n</dl>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 0 minutes  47.627 seconds)</p>\n<div class=\"sphx-glr-footer class sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-registration-syn-registration-3d-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/1376ee7b9d5065fa8ea9f1ba8006cbc2/syn_registration_3d.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">syn_registration_3d.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/48abac8a2081d1f8df0c855e08f8b247/syn_registration_3d.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">syn_registration_3d.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "examples_built/registration/syn_registration_3d.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Symmetric Diffeomorphic Registration in 3D</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/registration/syn_registration_3d", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}