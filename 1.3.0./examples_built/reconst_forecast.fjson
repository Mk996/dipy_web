{"parents": [], "prev": null, "next": null, "title": "Crossing invariant fiber response function with FORECAST model", "meta": {}, "body": "<div class=\"section\" id=\"crossing-invariant-fiber-response-function-with-forecast-model\">\n<span id=\"example-reconst-forecast\"></span><h1>Crossing invariant fiber response function with FORECAST model<a class=\"headerlink\" href=\"#crossing-invariant-fiber-response-function-with-forecast-model\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>We show how to obtain a voxel specific response function in the form of\naxially symmetric tensor and the fODF using the FORECAST model from\n<a class=\"reference internal\" href=\"../reconstruction/reconst_forecast/#anderson2005\" id=\"id1\"><span>[Anderson2005]</span></a> , <a class=\"reference internal\" href=\"../reconstruction/reconst_forecast/#kaden2016\" id=\"id2\"><span>[Kaden2016]</span></a> and <a class=\"reference internal\" href=\"../reconstruction/reconst_forecast/#zucchelli2017\" id=\"id3\"><span>[Zucchelli2017]</span></a>.</p>\n<p>First import the necessary modules:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">import</span> <span class=\"nn\">matplotlib.pyplot</span> <span class=\"k\">as</span> <span class=\"nn\">plt</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.forecast</span> <span class=\"k\">import</span> <span class=\"n\">ForecastModel</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"k\">import</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">window</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"k\">import</span> <span class=\"n\">fetch_cenir_multib</span><span class=\"p\">,</span> <span class=\"n\">read_cenir_multib</span><span class=\"p\">,</span> <span class=\"n\">get_sphere</span>\n</pre></div>\n</div>\n<p>Download and read the data for this tutorial.\nOur implementation of FORECAST requires multi-shell data.\nfetch_cenir_multib() provides data acquired using the shells at b-values 1000,\n2000, and 3000 (see MAPMRI example for more information on this dataset).</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fetch_cenir_multib</span><span class=\"p\">(</span><span class=\"n\">with_raw</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n\n<span class=\"n\">bvals</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"mi\">2000</span><span class=\"p\">,</span> <span class=\"mi\">3000</span><span class=\"p\">]</span>\n<span class=\"n\">img</span><span class=\"p\">,</span> <span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">read_cenir_multib</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">)</span>\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">asarray</span><span class=\"p\">(</span><span class=\"n\">img</span><span class=\"o\">.</span><span class=\"n\">dataobj</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Let us consider only a single slice for the FORECAST fitting</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">data_small</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mi\">87</span><span class=\"p\">,</span> <span class=\"mi\">51</span><span class=\"p\">:</span><span class=\"mi\">52</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"mi\">70</span><span class=\"p\">]</span>\n<span class=\"n\">mask_small</span> <span class=\"o\">=</span> <span class=\"n\">data_small</span><span class=\"p\">[</span><span class=\"o\">...</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1000</span>\n</pre></div>\n</div>\n<p>Instantiate the FORECAST Model.</p>\n<p>\u201csh_order\u201d is the spherical harmonics order used for the fODF.</p>\n<p>dec_alg is the spherical deconvolution algorithm used for the FORECAST basis\nfitting, in this case we used the Constrained Spherical Deconvolution (CSD)\nalgorithm.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fm</span> <span class=\"o\">=</span> <span class=\"n\">ForecastModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">sh_order</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"n\">dec_alg</span><span class=\"o\">=</span><span class=\"s1\">&#39;CSD&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Fit the FORECAST to the data</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">f_fit</span> <span class=\"o\">=</span> <span class=\"n\">fm</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">,</span> <span class=\"n\">mask_small</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Calculate the crossing invariant tensor indices <a class=\"reference internal\" href=\"../reconstruction/reconst_forecast/#kaden2016\" id=\"id4\"><span>[Kaden2016]</span></a> : the parallel\ndiffusivity, the perpendicular diffusivity, the fractional anisotropy and the\nmean diffusivity.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">d_par</span> <span class=\"o\">=</span> <span class=\"n\">f_fit</span><span class=\"o\">.</span><span class=\"n\">dpar</span>\n<span class=\"n\">d_perp</span> <span class=\"o\">=</span> <span class=\"n\">f_fit</span><span class=\"o\">.</span><span class=\"n\">dperp</span>\n<span class=\"n\">fa</span> <span class=\"o\">=</span> <span class=\"n\">f_fit</span><span class=\"o\">.</span><span class=\"n\">fractional_anisotropy</span><span class=\"p\">()</span>\n<span class=\"n\">md</span> <span class=\"o\">=</span> <span class=\"n\">f_fit</span><span class=\"o\">.</span><span class=\"n\">mean_diffusivity</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p>Show the indices and save them in FORECAST_indices.png.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">(</span><span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">))</span>\n<span class=\"n\">ax1</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"s1\">&#39;parallel diffusivity&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">d_par</span><span class=\"p\">[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">shrink</span><span class=\"o\">=</span><span class=\"mf\">0.6</span><span class=\"p\">)</span>\n<span class=\"n\">ax2</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"s1\">&#39;perpendicular diffusivity&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">d_perp</span><span class=\"p\">[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">shrink</span><span class=\"o\">=</span><span class=\"mf\">0.6</span><span class=\"p\">)</span>\n<span class=\"n\">ax3</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"s1\">&#39;fractional anisotropy&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">fa</span><span class=\"p\">[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">shrink</span><span class=\"o\">=</span><span class=\"mf\">0.6</span><span class=\"p\">)</span>\n<span class=\"n\">ax4</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"s1\">&#39;mean diffusivity&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax4</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax4</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">md</span><span class=\"p\">[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">shrink</span><span class=\"o\">=</span><span class=\"mf\">0.6</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;FORECAST_indices.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">dpi</span><span class=\"o\">=</span><span class=\"mi\">300</span><span class=\"p\">,</span> <span class=\"n\">bbox_inches</span><span class=\"o\">=</span><span class=\"s1\">&#39;tight&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id6\">\n<img alt=\"../../_images/FORECAST_indices.png\" src=\"../../_images/FORECAST_indices.png\" />\n<p class=\"caption\"><span class=\"caption-text\"><strong>FORECAST scalar indices</strong>.</span><a class=\"headerlink\" href=\"#id6\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<p>Load an ODF reconstruction sphere</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">sphere</span> <span class=\"o\">=</span> <span class=\"n\">get_sphere</span><span class=\"p\">(</span><span class=\"s1\">&#39;repulsion724&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Compute the fODFs.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">odf</span> <span class=\"o\">=</span> <span class=\"n\">f_fit</span><span class=\"o\">.</span><span class=\"n\">odf</span><span class=\"p\">(</span><span class=\"n\">sphere</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;fODF.shape (</span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">)&#39;</span> <span class=\"o\">%</span> <span class=\"n\">odf</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Display a part of the fODFs</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">odf_actor</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">odf_slicer</span><span class=\"p\">(</span><span class=\"n\">odf</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"p\">:,</span> <span class=\"mi\">30</span><span class=\"p\">:</span><span class=\"mi\">45</span><span class=\"p\">],</span> <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">sphere</span><span class=\"p\">,</span>\n                             <span class=\"n\">colormap</span><span class=\"o\">=</span><span class=\"s1\">&#39;plasma&#39;</span><span class=\"p\">,</span> <span class=\"n\">scale</span><span class=\"o\">=</span><span class=\"mf\">0.6</span><span class=\"p\">)</span>\n<span class=\"n\">odf_actor</span><span class=\"o\">.</span><span class=\"n\">display</span><span class=\"p\">(</span><span class=\"n\">y</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">odf_actor</span><span class=\"o\">.</span><span class=\"n\">RotateX</span><span class=\"p\">(</span><span class=\"o\">-</span><span class=\"mi\">90</span><span class=\"p\">)</span>\n<span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">odf_actor</span><span class=\"p\">)</span>\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;fODFs.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">600</span><span class=\"p\">,</span> <span class=\"mi\">600</span><span class=\"p\">),</span> <span class=\"n\">magnification</span><span class=\"o\">=</span><span class=\"mi\">4</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id7\">\n<img alt=\"../../_images/fODFs.png\" src=\"../../_images/fODFs.png\" />\n<p class=\"caption\"><span class=\"caption-text\"><strong>Fiber Orientation Distribution Functions, in a small ROI of the brain</strong>.</span><a class=\"headerlink\" href=\"#id7\" title=\"Permalink to this image\">\u00b6</a></p>\n</div>\n<div class=\"section\" id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<dl class=\"citation\">\n<dt class=\"label\" id=\"anderson2005\"><span class=\"brackets\"><a class=\"fn-backref\" href=\"#id1\">Anderson2005</a></span></dt>\n<dd><p>Anderson A. W., \u201cMeasurement of Fiber Orientation\nDistributions Using High Angular Resolution Diffusion Imaging\u201d, Magnetic\nResonance in Medicine, 2005.</p>\n</dd>\n<dt class=\"label\" id=\"kaden2016\"><span class=\"brackets\">Kaden2016</span><span class=\"fn-backref\">(<a href=\"#id2\">1</a>,<a href=\"#id4\">2</a>)</span></dt>\n<dd><p>Kaden E. et al., \u201cQuantitative Mapping of the Per-Axon Diffusion\nCoefficients in Brain White Matter\u201d, Magnetic Resonance in\nMedicine, 2016.</p>\n</dd>\n<dt class=\"label\" id=\"zucchelli2017\"><span class=\"brackets\"><a class=\"fn-backref\" href=\"#id3\">Zucchelli2017</a></span></dt>\n<dd><p>Zucchelli E. et al., \u201cA generalized SMT-based framework for\nDiffusion MRI microstructural model estimation\u201d, MICCAI Workshop\non Computational DIFFUSION MRI (CDMRI), 2017.</p>\n</dd>\n</dl>\n<div class=\"admonition-example-source-code admonition\">\n<p class=\"admonition-title\">Example source code</p>\n<p>You can download <a class=\"reference download internal\" download=\"\" href=\"../../_downloads/d9300f459ea3c92ad2ae7b607dc2a469/reconst_forecast.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">the</span> <span class=\"pre\">full</span> <span class=\"pre\">source</span> <span class=\"pre\">code</span> <span class=\"pre\">of</span> <span class=\"pre\">this</span> <span class=\"pre\">example</span></code></a>. This same script is also included in the dipy source distribution under the <code class=\"file docutils literal notranslate\"><span class=\"pre\">doc/examples/</span></code> directory.</p>\n</div>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "examples_built/reconst_forecast.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Crossing invariant fiber response function with FORECAST model</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/reconst_forecast", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}