{"parents": [], "prev": null, "next": null, "title": "Fiber to bundle coherence measures", "meta": {}, "body": "<section id=\"fiber-to-bundle-coherence-measures\">\n<span id=\"example-fiber-to-bundle-coherence\"></span><h1>Fiber to bundle coherence measures<a class=\"headerlink\" href=\"#fiber-to-bundle-coherence-measures\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>This demo presents the fiber to bundle coherence (FBC) quantitative\nmeasure of the alignment of each fiber with the surrounding fiber bundles\n<a class=\"reference internal\" href=\"#meesters2016\" id=\"id1\"><span>[Meesters2016]</span></a>. These measures are useful in \u2018cleaning\u2019 the results of\ntractography algorithms, since low FBCs indicate which fibers are isolated and\npoorly aligned with their neighbors, as shown in the figure below.</p>\n<figure class=\"align-center\" id=\"id7\">\n<span id=\"fiber-to-bundle-coherence\"></span><a class=\"reference internal image-reference\" href=\"../../_images/fbc_illustration.png\"><img alt=\"../../_images/fbc_illustration.png\" src=\"../../_images/fbc_illustration.png\" style=\"width: 384.0px; height: 101.39999999999999px;\" /></a>\n<figcaption>\n<p><span class=\"caption-text\">On the left this figure illustrates (in 2D) the contribution of two fiber\npoints to the kernel density estimator. The kernel density estimator is the\nsum over all such locally aligned kernels. The local fiber to bundle\ncoherence, shown on the right, color-coded for each fiber, is obtained by\nevaluating the kernel density estimator along the fibers. One spurious\nfiber is present which is isolated and badly aligned with the other fibers,\nand can be identified by a low LFBC value in the region where it deviates\nfrom the bundle. Figure adapted from <a class=\"reference internal\" href=\"#portegies2015\" id=\"id2\"><span>[Portegies2015]</span></a>.</span><a class=\"headerlink\" href=\"#id7\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p>Here we implement FBC measures based on kernel density estimation in the\nnon-flat 5D position-orientation domain. First we compute the kernel density\nestimator induced by the full lifted output (defined in the space of positions\nand orientations) of the tractography. Then, the Local FBC (LFBC) is the\nresult of evaluating the estimator along each element of the lifted fiber.\nA whole fiber measure, the relative FBC (RFBC), is calculated\nby the minimum of the moving average LFBC along the fiber.\nDetails of the computation of FBC can be found in <a class=\"reference internal\" href=\"#portegies2015\" id=\"id3\"><span>[Portegies2015]</span></a>.</p>\n<p>The FBC measures are evaluated on the Stanford HARDI dataset\n(150 orientations, b=2000 <span class=\"math notranslate nohighlight\">\\(s/mm^2\\)</span>) which is one of the standard example\ndatasets in <a class=\"reference external\" href=\"http://dipy.org\">DIPY</a>.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Enables/disables interactive visualization</span>\n<span class=\"n\">interactive</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">gradient_table</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">get_fnames</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.image</span> <span class=\"kn\">import</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">,</span> <span class=\"n\">load_nifti</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">read_bvals_bvecs</span>\n\n<span class=\"c1\"># Fix seed</span>\n<span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">seed</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Read data</span>\n<span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_hardi&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">label_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_labels&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">t1_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_t1&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">hardi_fname</span><span class=\"p\">)</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">label_fname</span><span class=\"p\">)</span>\n<span class=\"n\">t1_data</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">t1_fname</span><span class=\"p\">)</span>\n<span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span> <span class=\"o\">=</span> <span class=\"n\">read_bvals_bvecs</span><span class=\"p\">(</span><span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span><span class=\"p\">)</span>\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span><span class=\"p\">)</span>\n\n\n\n<span class=\"c1\"># Select a relevant part of the data (left hemisphere)</span>\n<span class=\"c1\"># Coordinates given in x bounds, y bounds, z bounds</span>\n<span class=\"n\">dshape</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n<span class=\"n\">xa</span><span class=\"p\">,</span> <span class=\"n\">xb</span><span class=\"p\">,</span> <span class=\"n\">ya</span><span class=\"p\">,</span> <span class=\"n\">yb</span><span class=\"p\">,</span> <span class=\"n\">za</span><span class=\"p\">,</span> <span class=\"n\">zb</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"mi\">15</span><span class=\"p\">,</span> <span class=\"mi\">42</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">65</span><span class=\"p\">,</span> <span class=\"mi\">18</span><span class=\"p\">,</span> <span class=\"mi\">65</span><span class=\"p\">]</span>\n<span class=\"n\">data_small</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">xa</span><span class=\"p\">:</span><span class=\"n\">xb</span><span class=\"p\">,</span> <span class=\"n\">ya</span><span class=\"p\">:</span><span class=\"n\">yb</span><span class=\"p\">,</span> <span class=\"n\">za</span><span class=\"p\">:</span><span class=\"n\">zb</span><span class=\"p\">]</span>\n<span class=\"n\">selectionmask</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">zeros</span><span class=\"p\">(</span><span class=\"n\">dshape</span><span class=\"p\">,</span> <span class=\"s1\">&#39;bool&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">selectionmask</span><span class=\"p\">[</span><span class=\"n\">xa</span><span class=\"p\">:</span><span class=\"n\">xb</span><span class=\"p\">,</span> <span class=\"n\">ya</span><span class=\"p\">:</span><span class=\"n\">yb</span><span class=\"p\">,</span> <span class=\"n\">za</span><span class=\"p\">:</span><span class=\"n\">zb</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</pre></div>\n</div>\n<p>The data is first fitted to the Constant Solid Angle (CDA) ODF Model. CSA is a\ngood choice to estimate general fractional anisotropy (GFA), which the stopping\ncriterion can use to restrict fiber tracking to those areas where the ODF\nshows significant restricted diffusion, thus creating a region-of-interest in\nwhich the computations are done.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Perform CSA</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.shm</span> <span class=\"kn\">import</span> <span class=\"n\">CsaOdfModel</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">default_sphere</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">peaks_from_model</span>\n\n<span class=\"n\">csa_model</span> <span class=\"o\">=</span> <span class=\"n\">CsaOdfModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">sh_order</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">)</span>\n<span class=\"n\">csa_peaks</span> <span class=\"o\">=</span> <span class=\"n\">peaks_from_model</span><span class=\"p\">(</span><span class=\"n\">csa_model</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">default_sphere</span><span class=\"p\">,</span>\n                             <span class=\"n\">relative_peak_threshold</span><span class=\"o\">=</span><span class=\"mf\">.6</span><span class=\"p\">,</span>\n                             <span class=\"n\">min_separation_angle</span><span class=\"o\">=</span><span class=\"mi\">45</span><span class=\"p\">,</span>\n                             <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">selectionmask</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Stopping Criterion</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.stopping_criterion</span> <span class=\"kn\">import</span> <span class=\"n\">ThresholdStoppingCriterion</span>\n\n<span class=\"n\">stopping_criterion</span> <span class=\"o\">=</span> <span class=\"n\">ThresholdStoppingCriterion</span><span class=\"p\">(</span><span class=\"n\">csa_peaks</span><span class=\"o\">.</span><span class=\"n\">gfa</span><span class=\"p\">,</span> <span class=\"mf\">0.25</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>In order to perform probabilistic fiber tracking we first fit the data to the\nConstrained Spherical Deconvolution (CSD) model in DIPY. This model represents\neach voxel in the data set as a collection of small white matter fibers with\ndifferent orientations. The density of fibers along each orientation is known\nas the Fiber Orientation Distribution (FOD), used in the fiber tracking.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Perform CSD on the original data</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"kn\">import</span> <span class=\"n\">auto_response_ssst</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"kn\">import</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span>\n\n<span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">ratio</span> <span class=\"o\">=</span> <span class=\"n\">auto_response_ssst</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">roi_radii</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">fa_thr</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n<span class=\"n\">csd_model</span> <span class=\"o\">=</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit</span> <span class=\"o\">=</span> <span class=\"n\">csd_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit_shm</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">lib</span><span class=\"o\">.</span><span class=\"n\">pad</span><span class=\"p\">(</span><span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span><span class=\"p\">,</span> <span class=\"p\">((</span><span class=\"n\">xa</span><span class=\"p\">,</span> <span class=\"n\">dshape</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">-</span><span class=\"n\">xb</span><span class=\"p\">),</span>\n                                             <span class=\"p\">(</span><span class=\"n\">ya</span><span class=\"p\">,</span> <span class=\"n\">dshape</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">-</span><span class=\"n\">yb</span><span class=\"p\">),</span>\n                                             <span class=\"p\">(</span><span class=\"n\">za</span><span class=\"p\">,</span> <span class=\"n\">dshape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">-</span><span class=\"n\">zb</span><span class=\"p\">),</span>\n                                             <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">)),</span> <span class=\"s1\">&#39;constant&#39;</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Probabilistic direction getting for fiber tracking</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">ProbabilisticDirectionGetter</span>\n\n<span class=\"n\">prob_dg</span> <span class=\"o\">=</span> <span class=\"n\">ProbabilisticDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span><span class=\"n\">csd_fit_shm</span><span class=\"p\">,</span>\n                                                    <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">30.</span><span class=\"p\">,</span>\n                                                    <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The optic radiation is reconstructed by tracking fibers from the calcarine\nsulcus (visual cortex V1) to the lateral geniculate nucleus (LGN). We seed\nfrom the calcarine sulcus by selecting a region-of-interest (ROI) cube of\ndimensions 3x3x3 voxels.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Set a seed region region for tractography.</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking</span> <span class=\"kn\">import</span> <span class=\"n\">utils</span>\n\n<span class=\"n\">mask</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">zeros</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"s1\">&#39;bool&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">rad</span> <span class=\"o\">=</span> <span class=\"mi\">3</span>\n<span class=\"n\">mask</span><span class=\"p\">[</span><span class=\"mi\">26</span><span class=\"o\">-</span><span class=\"n\">rad</span><span class=\"p\">:</span><span class=\"mi\">26</span><span class=\"o\">+</span><span class=\"n\">rad</span><span class=\"p\">,</span> <span class=\"mi\">29</span><span class=\"o\">-</span><span class=\"n\">rad</span><span class=\"p\">:</span><span class=\"mi\">29</span><span class=\"o\">+</span><span class=\"n\">rad</span><span class=\"p\">,</span> <span class=\"mi\">31</span><span class=\"o\">-</span><span class=\"n\">rad</span><span class=\"p\">:</span><span class=\"mi\">31</span><span class=\"o\">+</span><span class=\"n\">rad</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n<span class=\"n\">seeds</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">seeds_from_mask</span><span class=\"p\">(</span><span class=\"n\">mask</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">density</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">])</span>\n</pre></div>\n</div>\n<p>Local Tracking is used for probabilistic tractography which takes the\ndirection getter along with the stopping criterion and seeds as input.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Perform tracking using Local Tracking</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local_tracking</span> <span class=\"kn\">import</span> <span class=\"n\">LocalTracking</span>\n\n<span class=\"n\">streamlines_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">prob_dg</span><span class=\"p\">,</span> <span class=\"n\">stopping_criterion</span><span class=\"p\">,</span> <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                      <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Compute streamlines.</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">Streamlines</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamlines_generator</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>In order to select only the fibers that enter into the LGN, another ROI is\ncreated from a cube of size 5x5x5 voxels. The near_roi command is used to find\nthe fibers that traverse through this ROI.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Set a mask for the lateral geniculate nucleus (LGN)</span>\n<span class=\"n\">mask_lgn</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">zeros</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"s1\">&#39;bool&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">rad</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n<span class=\"n\">mask_lgn</span><span class=\"p\">[</span><span class=\"mi\">35</span><span class=\"o\">-</span><span class=\"n\">rad</span><span class=\"p\">:</span><span class=\"mi\">35</span><span class=\"o\">+</span><span class=\"n\">rad</span><span class=\"p\">,</span> <span class=\"mi\">42</span><span class=\"o\">-</span><span class=\"n\">rad</span><span class=\"p\">:</span><span class=\"mi\">42</span><span class=\"o\">+</span><span class=\"n\">rad</span><span class=\"p\">,</span> <span class=\"mi\">28</span><span class=\"o\">-</span><span class=\"n\">rad</span><span class=\"p\">:</span><span class=\"mi\">28</span><span class=\"o\">+</span><span class=\"n\">rad</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n<span class=\"c1\"># Select all the fibers that enter the LGN and discard all others</span>\n<span class=\"n\">filtered_fibers2</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">near_roi</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">mask_lgn</span><span class=\"p\">,</span> <span class=\"n\">tol</span><span class=\"o\">=</span><span class=\"mf\">1.8</span><span class=\"p\">)</span>\n\n<span class=\"n\">sfil</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n<span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)):</span>\n    <span class=\"k\">if</span> <span class=\"n\">filtered_fibers2</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]:</span>\n        <span class=\"n\">sfil</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">sfil</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Inspired by <a class=\"reference internal\" href=\"#rodrigues2010\" id=\"id4\"><span>[Rodrigues2010]</span></a>, a lookup-table is created, containing rotated\nversions of the fiber propagation kernel <span class=\"math notranslate nohighlight\">\\(P_t\\)</span> <a class=\"reference internal\" href=\"#duitsandfranken2011\" id=\"id5\"><span>[DuitsAndFranken2011]</span></a>\nrotated over a discrete set of orientations. See the\n<a class=\"reference external\" href=\"https://dipy.org/documentation/latest/examples_built/contextual_enhancement/#example-contextual-enhancement\">Contextual enhancement example</a>\nfor more details regarding the kernel. In order to ensure rotationally\ninvariant processing, the discrete orientations are required to be equally\ndistributed over a sphere. By default, a sphere with 100 directions is obtained\nfrom electrostatic repulsion in DIPY.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Compute lookup table</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.denoise.enhancement_kernel</span> <span class=\"kn\">import</span> <span class=\"n\">EnhancementKernel</span>\n\n<span class=\"n\">D33</span> <span class=\"o\">=</span> <span class=\"mf\">1.0</span>\n<span class=\"n\">D44</span> <span class=\"o\">=</span> <span class=\"mf\">0.02</span>\n<span class=\"n\">t</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n<span class=\"n\">k</span> <span class=\"o\">=</span> <span class=\"n\">EnhancementKernel</span><span class=\"p\">(</span><span class=\"n\">D33</span><span class=\"p\">,</span> <span class=\"n\">D44</span><span class=\"p\">,</span> <span class=\"n\">t</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The FBC measures are now computed, taking the tractography results and the\nlookup tables as input.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Apply FBC measures</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.fbcmeasures</span> <span class=\"kn\">import</span> <span class=\"n\">FBCMeasures</span>\n\n<span class=\"n\">fbc</span> <span class=\"o\">=</span> <span class=\"n\">FBCMeasures</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>After calculating the FBC measures, a threshold can be chosen on the relative\nFBC (RFBC) in order to remove spurious fibers. Recall that the relative FBC\n(RFBC) is calculated by the minimum of the moving average LFBC along the fiber.\nIn this example we show the results for threshold 0 (i.e. all fibers are\nincluded) and 0.2 (removing the 20 percent most spurious fibers).</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Calculate LFBC for original fibers</span>\n<span class=\"n\">fbc_sl_orig</span><span class=\"p\">,</span> <span class=\"n\">clrs_orig</span><span class=\"p\">,</span> <span class=\"n\">rfbc_orig</span> <span class=\"o\">=</span> \\\n  <span class=\"n\">fbc</span><span class=\"o\">.</span><span class=\"n\">get_points_rfbc_thresholded</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">emphasis</span><span class=\"o\">=</span><span class=\"mf\">0.01</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Apply a threshold on the RFBC to remove spurious fibers</span>\n<span class=\"n\">fbc_sl_thres</span><span class=\"p\">,</span> <span class=\"n\">clrs_thres</span><span class=\"p\">,</span> <span class=\"n\">rfbc_thres</span> <span class=\"o\">=</span> \\\n  <span class=\"n\">fbc</span><span class=\"o\">.</span><span class=\"n\">get_points_rfbc_thresholded</span><span class=\"p\">(</span><span class=\"mf\">0.125</span><span class=\"p\">,</span> <span class=\"n\">emphasis</span><span class=\"o\">=</span><span class=\"mf\">0.01</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The results of FBC measures are visualized, showing the original fibers\ncolored by LFBC (see <a class=\"reference internal\" href=\"#optic-radiation-before-cleaning\"><span class=\"std std-ref\">The optic radiation obtained through probabilistic tractography colored by\nlocal fiber to bundle coherence.</span></a>), and the fibers\nafter the cleaning procedure via RFBC thresholding (see\n<a class=\"reference internal\" href=\"#optic-radiation-after-cleaning\"><span class=\"std std-ref\">The tractography result is cleaned (shown in bottom) by removing fibers\nwith a relative FBC (RFBC) lower than the threshold \\tau = 0.2.</span></a>).</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Visualize the results</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"kn\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span>\n\n<span class=\"c1\"># Create scene</span>\n<span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n\n<span class=\"c1\"># Original lines colored by LFBC</span>\n<span class=\"n\">lineactor</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">fbc_sl_orig</span><span class=\"p\">,</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">vstack</span><span class=\"p\">(</span><span class=\"n\">clrs_orig</span><span class=\"p\">),</span> <span class=\"n\">linewidth</span><span class=\"o\">=</span><span class=\"mf\">0.2</span><span class=\"p\">)</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">lineactor</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Horizontal (axial) slice of T1 data</span>\n<span class=\"n\">vol_actor1</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">slicer</span><span class=\"p\">(</span><span class=\"n\">t1_data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"o\">=</span><span class=\"n\">affine</span><span class=\"p\">)</span>\n<span class=\"n\">vol_actor1</span><span class=\"o\">.</span><span class=\"n\">display</span><span class=\"p\">(</span><span class=\"n\">z</span><span class=\"o\">=</span><span class=\"mi\">20</span><span class=\"p\">)</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">vol_actor1</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Vertical (sagittal) slice of T1 data</span>\n<span class=\"n\">vol_actor2</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">slicer</span><span class=\"p\">(</span><span class=\"n\">t1_data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"o\">=</span><span class=\"n\">affine</span><span class=\"p\">)</span>\n<span class=\"n\">vol_actor2</span><span class=\"o\">.</span><span class=\"n\">display</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"o\">=</span><span class=\"mi\">35</span><span class=\"p\">)</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">vol_actor2</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Show original fibers</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">set_camera</span><span class=\"p\">(</span><span class=\"n\">position</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"o\">-</span><span class=\"mi\">264</span><span class=\"p\">,</span> <span class=\"mi\">285</span><span class=\"p\">,</span> <span class=\"mi\">155</span><span class=\"p\">),</span>\n                 <span class=\"n\">focal_point</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"o\">-</span><span class=\"mi\">14</span><span class=\"p\">,</span> <span class=\"mi\">9</span><span class=\"p\">),</span>\n                 <span class=\"n\">view_up</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">n_frames</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;OR_before.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">900</span><span class=\"p\">,</span> <span class=\"mi\">900</span><span class=\"p\">))</span>\n<span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Show thresholded fibers</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">rm</span><span class=\"p\">(</span><span class=\"n\">lineactor</span><span class=\"p\">)</span>\n<span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">fbc_sl_thres</span><span class=\"p\">,</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">vstack</span><span class=\"p\">(</span><span class=\"n\">clrs_thres</span><span class=\"p\">),</span> <span class=\"n\">linewidth</span><span class=\"o\">=</span><span class=\"mf\">0.2</span><span class=\"p\">))</span>\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">n_frames</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;OR_after.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">900</span><span class=\"p\">,</span> <span class=\"mi\">900</span><span class=\"p\">))</span>\n<span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<figure class=\"align-center\" id=\"id8\">\n<span id=\"optic-radiation-before-cleaning\"></span><img alt=\"../../_images/OR_before.png\" src=\"../../_images/OR_before.png\" />\n<figcaption>\n<p><span class=\"caption-text\">The optic radiation obtained through probabilistic tractography colored by\nlocal fiber to bundle coherence.</span><a class=\"headerlink\" href=\"#id8\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<figure class=\"align-center\" id=\"id9\">\n<span id=\"optic-radiation-after-cleaning\"></span><img alt=\"../../_images/OR_after.png\" src=\"../../_images/OR_after.png\" />\n<figcaption>\n<p><span class=\"caption-text\">The tractography result is cleaned (shown in bottom) by removing fibers\nwith a relative FBC (RFBC) lower than the threshold <span class=\"math notranslate nohighlight\">\\(\\tau = 0.2\\)</span>.</span><a class=\"headerlink\" href=\"#id9\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<section id=\"acknowledgments\">\n<h2>Acknowledgments<a class=\"headerlink\" href=\"#acknowledgments\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>The techniques are developed in close collaboration with Pauly Ossenblok of\nthe Academic Center of Epileptology Kempenhaeghe &amp; Maastricht UMC+.</p>\n</section>\n<section id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<div role=\"list\" class=\"citation-list\">\n<div class=\"citation\" id=\"meesters2016\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id1\">Meesters2016</a><span class=\"fn-bracket\">]</span></span>\n<p>S. Meesters, G. Sanguinetti, E. Garyfallidis, J. Portegies,\nP. Ossenblok, R. Duits. (2016) Cleaning output of tractography via fiber to\nbundle coherence, a new open source implementation. Human Brain Mapping\nConference 2016.</p>\n</div>\n<div class=\"citation\" id=\"portegies2015\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span>Portegies2015<span class=\"fn-bracket\">]</span></span>\n<span class=\"backrefs\">(<a role=\"doc-backlink\" href=\"#id2\">1</a>,<a role=\"doc-backlink\" href=\"#id3\">2</a>)</span>\n<p>J. Portegies, R. Fick, G. Sanguinetti, S. Meesters,\nG.Girard, and R. Duits. (2015) Improving Fiber Alignment in HARDI by\nCombining Contextual PDE flow with Constrained Spherical Deconvolution. PLoS\nOne.</p>\n</div>\n<div class=\"citation\" id=\"duitsandfranken2011\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id5\">DuitsAndFranken2011</a><span class=\"fn-bracket\">]</span></span>\n<p>R. Duits and E. Franken (2011) Left-invariant\ndiffusions on the space of positions and orientations and their application\nto crossing-preserving smoothing of HARDI images. International Journal of\nComputer Vision, 92:231-264.</p>\n</div>\n<div class=\"citation\" id=\"rodrigues2010\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id4\">Rodrigues2010</a><span class=\"fn-bracket\">]</span></span>\n<p>P. Rodrigues, R. Duits, B. Romeny, A. Vilanova (2010).\nAccelerated Diffusion Operators for Enhancing DW-MRI. Eurographics Workshop\non Visual Computing for Biology and Medicine. The Eurographics Association.</p>\n</div>\n</div>\n<div class=\"admonition-example-source-code admonition\">\n<p class=\"admonition-title\">Example source code</p>\n<p>You can download <a class=\"reference download internal\" download=\"\" href=\"../../_downloads/b889e2c93d6b1588fc55ceffc154943f/fiber_to_bundle_coherence.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">the</span> <span class=\"pre\">full</span> <span class=\"pre\">source</span> <span class=\"pre\">code</span> <span class=\"pre\">of</span> <span class=\"pre\">this</span> <span class=\"pre\">example</span></code></a>. This same script is also included in the dipy source distribution under the <code class=\"file docutils literal notranslate\"><span class=\"pre\">doc/examples/</span></code> directory.</p>\n</div>\n</section>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "examples_built/fiber_to_bundle_coherence.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Fiber to bundle coherence measures</a><ul>\n<li><a class=\"reference internal\" href=\"#acknowledgments\">Acknowledgments</a></li>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/fiber_to_bundle_coherence", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}